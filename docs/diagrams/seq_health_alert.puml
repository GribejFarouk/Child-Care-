@startuml seq_health_alert
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true
skinparam maxMessageSize 200

title Diagramme de S√©quence 5 ‚Äî G√©n√©ration et Consultation des Alertes Sant√©

actor "Parent" as User
participant "Interface React\n(Frontend)" as UI
participant "Serveur API\n(Backend)" as API
participant "Moteur d'Alertes" as AlertEngine
participant "Service de\nNotifications" as Notif
database "Base de Donn√©es" as DB

== D√©clenchement automatique (apr√®s ajout de mesure) ==

API -> AlertEngine : Nouvelle mesure enregistr√©e\n{childId, weight, height, date}
AlertEngine -> DB : SELECT standards OMS\nWHERE age = ? AND sex = ?
DB --> AlertEngine : Percentiles de r√©f√©rence\n(P3, P50, P97)

AlertEngine -> AlertEngine : Analyse :\n1. Poids < P3 ou > P97 ?\n2. Taille < P3 ou > P97 ?\n3. Variation brusque vs mesure pr√©c√©dente ?\n4. IMC hors normes ?

alt Aucune anomalie d√©tect√©e
    AlertEngine --> API : Pas d'alerte n√©cessaire
else Anomalie d√©tect√©e (ex: poids < P3)
    AlertEngine -> AlertEngine : D√©termine la s√©v√©rit√© :\n- danger : hors P3/P97\n- warning : tendance pr√©occupante\n- info : rappel vaccination
    
    AlertEngine -> DB : INSERT INTO alerts\n(child_id, type, priority,\ntitle, message, date)
    DB --> AlertEngine : Alerte cr√©√©e (id)
    
    AlertEngine -> Notif : Envoie notification push
    Notif --> User : üîî Notification :\n"Alerte poids pour {enfant}"
end

== Consultation des alertes ==

User -> UI : Acc√®de au Centre d'Alertes\n(via cloche ou sidebar)
UI -> API : GET /api/alerts\n?read={all|true|false}&type={filter}
API -> DB : SELECT * FROM alerts\nWHERE parent_id = ?\nORDER BY date DESC
DB --> API : Liste des alertes
API --> UI : 200 OK [{alerts}]

UI --> User : Affiche la liste des alertes\n(ic√¥nes par type, badges de priorit√©,\nstatut lu/non-lu)

== Interaction avec une alerte ==

User -> UI : Clique sur une alerte
UI -> API : PATCH /api/alerts/{id}\n{read: true}
API -> DB : UPDATE alerts\nSET read = true\nWHERE id = ?
DB --> API : OK
API --> UI : 200 OK

UI --> User : Alerte marqu√©e comme lue\n(style visuel att√©nu√©)

== Marquer toutes comme lues ==

User -> UI : Clique "Tout marquer comme lu"
UI -> API : PATCH /api/alerts/mark-all-read
API -> DB : UPDATE alerts\nSET read = true\nWHERE parent_id = ?
DB --> API : OK
API --> UI : 200 OK
UI --> User : Toutes les alertes\npassent en style "lu"

note over UI, User
    **Avertissement m√©dical permanent :**
    "Les alertes sont g√©n√©r√©es automatiquement
    √† titre informatif. Elles ne constituent pas
    un diagnostic m√©dical. En cas de doute,
    consultez votre p√©diatre."
end note

@enduml
